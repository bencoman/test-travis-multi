language: c


osx_image: 
  - xcode7.3

dist: trusty

stages:
  - Production
  - Test # The 'Test' stage is formed from 'os:' section crosstabbed with 'env:' section

os:
  -       linux
  -       osx 
  -       windows
          #
env:      #    
  - BUILD=64x64/squeak.cog.spur     TESTIMAGE=skip
  - BUILD=64x64/pharo.cog.spur      TESTIMAGE=skip
  - BUILD=64x64/newspeak.cog.spur   TESTIMAGE=skip

  - BUILD=32x86/squeak.cog.spur     TESTIMAGE=Squeak32-5.1
  - BUILD=32x86/pharo.cog.spur      TESTIMAGE=Pharo32-5.0
  - BUILD=32x86/newspeak.cog.spur   TESTIMAGE="refer newspeakBootstrap.sh"
  - BUILD=32x86/squeak.cog.v3       TESTIMAGE=Squeak32-4.6

  - BUILD=64x64/squeak.cog.stack    TESTIMAGE=skip
  - BUILD=64x64/pharo.cog.stack     TESTIMAGE=skip
  - BUILD=64x64/newspeak.cog.stack  TESTIMAGE="refer newspeakBootstrap.sh"

  - BUILD=32x86/squeak.cog.stack    TESTIMAGE=Squeak32-5.1
  - BUILD=32x86/pharo.cog.stack     TESTIMAGE=Pharo32-5.0
  - BUILD=32x86/newspeak.cog.stack  TESTIMAGE=skip
  - BUILD=32x86/squeak.stack.v3     TESTIMAGE=Squeak32-4.6

script:
  - ./travis_build.sh 

jobs:
  fast_finish: true
  include:

    - stage: PRODUCTION
      os:        linux
      env: BUILD=64x64/squeak.cog.spur PRODUCTION=linux TESTIMAGE=skip
    
    - os:        linux
      env: BUILD=64x64/pharo.cog.spur  PRODUCTION=linux TESTIMAGE=skip
    
    - os:        osx
      env: BUILD=64x64/squeak.cog.spur PRODUCTION=osx TESTIMAGE=skip
    
    - os:        osx
      env: BUILD=64x64/pharo.cog.spur PRODUCTION=osx TESTIMAGE=skip
    
    - os:        linux
      env: BUILD=32x86/squeak.cog.spur PRODUCTION=linux TESTIMAGE=Squeak32-5.1
    
    - os:        linux
      env: BUILD=32x86/pharo.cog.spur PRODUCTION=linux TESTIMAGE=Pharo32-5.0
    
    - os:        osx
      env: BUILD=32x86/squeak.cog.spur PRODUCTION=osx TESTIMAGE=Squeak32-5.1
    
    - os:        osx
      env: BUILD=32x86/pharo.cog.spur PRODUCTION=osx TESTIMAGE=Pharo32-5.0
    

    - stage: EXPERIMENTAL LOWCODE & SISTA (failures allowed)
      # SISTA
      os:       osx
      env: BUILD=32x86/pharo.sista.spur FAIL=OK

    - os:       linux
      env: BUILD=32x86/squeak.sista.spur  FAIL=OK

    - os:       linux
      env: BUILD=32x86/squeak.sista.spur  FAIL=OK

    - os:       linux
      compiler: clang
      env: BUILD=32x86/pharo.sista.spur FAIL=OK HEARTBEAT=threaded

    - os:       linux
      compiler: clang
      env: BUILD=32x86/pharo.sista.spur FAIL=OK HEARTBEAT=itimer

      # LOWCODE
    - os:       osx
      env: BUILD=32x86/pharo.cog.spur.lowcode FAIL=OK

    - os:       osx
      env: BUILD=64x64/pharo.cog.spur.lowcode FAIL=OK

    - os:       osx
      env: BUILD=32x86/pharo.stack.spur.lowcode FAIL=OK

    - os:       osx
      env: BUILD=64x64/pharo.stack.spur.lowcode FAIL=OK


    - stage: OTHER BUILDS
      os:       linux
      env: BUILD=32x86/pharo.cog.spur      HEARTBEAT=itimer

    - os:       linux
      env: BUILD=64x64/pharo.cog.spur      HEARTBEAT=itimer


    - stage: Linux32ARMv6
      os:       linux
      env: BUILD=32ARMv6/newspeak.cog.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: BUILD=32ARMv6/newspeak.stack.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: BUILD=32ARMv6/squeak.cog.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: BUILD=32ARMv6/pharo.cog.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: BUILD=32ARMv6/squeak.stack.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: BUILD=32ARMv6/squeak.stack.v3 CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

  allow_failures:
  - env: FAIL=OK


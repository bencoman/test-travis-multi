language: c

os:
  - linux
  - osx 
  - windows

osx_image: 
  - xcode7.3

dist: trusty

stages:
  - Production
  - Tests

env:
  - ARCH=64x64  FLAVOR=squeak.cog.spur
  - ARCH=64x64  FLAVOR=pharo.cog.spur      LINUX_HEARTBEAT=threaded
  - ARCH=64x64  FLAVOR=newspeak.cog.spur

  - ARCH=32x86  FLAVOR=squeak.cog.spur
  - ARCH=32x86  FLAVOR=pharo.cog.spur      LINUX_HEARTBEAT=threaded
  - ARCH=32x86  FLAVOR=newspeak.cog.spur
  - ARCH=32x86  FLAVOR=squeak.cog.v3

  - ARCH=64x64  FLAVOR=squeak.cog.stack
  - ARCH=64x64  FLAVOR=pharo.cog.stack   # linux not built
  - ARCH=64x64  FLAVOR=newspeak.cog.stack

  - ARCH=32x86  FLAVOR=squeak.cog.stack
  - ARCH=32x86  FLAVOR=pharo.cog.stack   # linux not built
  - ARCH=32x86  FLAVOR=newspeak.cog.stack
  - ARCH=32x86  FLAVOR=squeak.stack.v3

jobs:
  include:
    - stage: ADHOC LINUX BUILDS
      os: linux
      env: ARCH=32x86  FLAVOR=pharo.cog.spur      LINUX_HEARTBEAT=itimer

    - os:       linux
      env: ARCH=64x64  FLAVOR=pharo.cog.spur      LINUX_HEARTBEAT=itimer


    - stage: EXPERIMENTAL LOWCODE (failures allowed)
      os:       osx
      env: ARCH=32x86  FLAVOR=pharo.cog.spur.lowcode

    - os:       osx
      env: ARCH=64x64  FLAVOR=pharo.cog.spur.lowcode

    - os:       osx
      env: ARCH=32x86  FLAVOR=pharo.stack.spur.lowcode

    - os:       osx
      env: ARCH=64x64  FLAVOR=pharo.stack.spur.lowcode


    - stage: EXPERIMENTAL SISTA (failures allowed)
      os:       osx
      env: ARCH=32x86 FLAVOR=pharo.sista.spur

    - os:       linux
      env: ARCH=32x86 FLAVOR=pharo.sista.spur HEARTBEAT=threaded
      compiler: clang

    - os:       linux
      env: ARCH=32x86 FLAVOR=pharo.sista.spur HEARTBEAT=itimer 
      compiler: clang

    - os:       linux
      env: ARCH=32x86 FLAVOR=squeak.sista.spur 

    - os:       linux
      env: ARCH=32x86 FLAVOR=squeak.sista.spur 


    - stage: Linux32ARMv6
      os:       linux
      env: ARCH=linux32ARMv6 FLAVOR=newspeak.cog.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: ARCH=linux32ARMv6 FLAVOR=newspeak.stack.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: ARCH=linux32ARMv6 FLAVOR=squeak.cog.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: ARCH=linux32ARMv6 FLAVOR=pharo.cog.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: ARCH=linux32ARMv6 FLAVOR=squeak.stack.spur CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge

    - os:       linux
      env: ARCH=linux32ARMv6 FLAVOR=squeak.stack.v3 CHROOT="schroot -p -c rpi -- bash -c"
      group:    edge


  allow_failures:
  - env: FLAVOR=squeak.sista.spur
  - env: FLAVOR=pharo.sista.spur
  - env: FLAVOR=squeak.cog.spur.lowcode
  - env: FLAVOR=pharo.cog.spur.lowcode

script:
  - uname -a
  - echo BUILDING... build${PLATFORM}${ARCH}/${FLAVOR}
  - env | sort
#  - find / -maxdepth 2 -print -name proc -prune || true
#  - find /proc -maxdepth 2
